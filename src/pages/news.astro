---
import BaseLayout from "../layouts/BaseLayout.astro";
import Section from "../components/Section.astro";
import Card from "../components/Card.astro";
import CTAButtons from "../components/CTAButtons.astro";
import { getCollection } from "astro:content";

const news = await getCollection("news");
const sortedNews = news.sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);
const visibleCount = 6;
const hasOverflow = sortedNews.length > visibleCount;
const formatDate = (date) =>
  date.toLocaleDateString("en-US", {
    month: "long",
    day: "numeric",
    year: "numeric",
    timeZone: "UTC",
  });
---

<BaseLayout
  title="News | Midway Wrestling Club"
  description="Club news, event updates, and announcements for Midway Wrestling Club."
>
  <Section
    eyebrow="News"
    title="Club news and updates"
    intro="Announcements, event recaps, and upcoming opportunities."
  >
    <div class="grid grid-2 grid-3 news-grid">
      {sortedNews.map((entry, index) => {
        const isLogoCover = entry.data.coverStyle === "logo";
        return (
          <div class="news-item" data-news-card>
            <Card
              meta={formatDate(entry.data.date)}
              title={entry.data.title}
              description={entry.data.excerpt}
            >
              {entry.data.cover &&
                (isLogoCover ? (
                  <div slot="media" class="card-media__frame card-media__frame--logo">
                    <img
                      class="card-media__logo"
                      src={entry.data.cover}
                      alt=""
                      loading="lazy"
                      decoding="async"
                    />
                  </div>
                ) : (
                  <div slot="media" class="card-media__frame">
                    <img
                      class="card-media__img"
                      src={entry.data.cover}
                      alt=""
                      loading="lazy"
                      decoding="async"
                    />
                  </div>
                ))}
              <a class="btn outline" href={`/news/${entry.slug}`}>Read Article</a>
            </Card>
          </div>
        );
      })}
    </div>
    {hasOverflow && (
      <div class="cta-row">
        <button
          class="btn outline"
          type="button"
          data-news-toggle
          aria-expanded="true"
        >
          Hide older news
        </button>
      </div>
    )}
  </Section>

  <Section
    eyebrow="Stay in the loop"
    title="Want news in your inbox?"
    intro="Join updates for schedule changes and announcements."
  >
    <CTAButtons
      primaryLabel="Call/Text Coach"
      primaryHref="tel:+19704242757"
      secondaryLabel="Join Updates"
      secondaryHref="/join"
      secondaryVariant="outline"
    />
  </Section>

  {hasOverflow && (
    <script is:inline define:vars={{ visibleCount }}>
      const toggle = document.querySelector("[data-news-toggle]");
      const cards = Array.from(document.querySelectorAll("[data-news-card]"));
      const maxVisible =
        Number.isInteger(visibleCount) && visibleCount > 0 ? visibleCount : 0;

      if (toggle && cards.length) {
        let expanded = true;
        const update = () => {
          cards.forEach((card, index) => {
            const isOlder = index >= maxVisible;
            card.hidden = !expanded && isOlder;
          });
          toggle.textContent = expanded ? "Hide older news" : "View all news";
          toggle.setAttribute("aria-expanded", String(expanded));
        };
        update();
        toggle.addEventListener("click", () => {
          expanded = !expanded;
          update();
        });
      }
    </script>
  )}
</BaseLayout>
