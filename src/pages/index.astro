---
import BaseLayout from "../layouts/BaseLayout.astro";
import Hero from "../components/Hero.astro";
import Section from "../components/Section.astro";
import Card from "../components/Card.astro";
import { getCollection } from "astro:content";
import { readdir } from "node:fs/promises";

const news = await getCollection("news");
const latestNews = news
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 3);
const formatDate = (date) =>
  date.toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    timeZone: "UTC",
  });

const photosDir = new URL("../../public/photos", import.meta.url);
const photoFiles = await readdir(photosDir);
const photoItems = photoFiles
  .filter((file) => /\.(png|jpe?g|webp|gif|avif)$/i.test(file))
  .map((file) => {
    const label = file.replace(/\.[^.]+$/, "").replace(/[-_]+/g, " ").trim();
    return {
      src: `/photos/${file}`,
      alt: label ? `${label} photo` : "Midway Wrestling Club photo",
    };
  });
const placeholderPhotos = [
  { label: "Live goes" },
  { label: "Technique reps" },
  { label: "Team focus" },
  { label: "Tournament day" },
];
const displayPhotos = photoItems.length ? photoItems : placeholderPhotos;
---

<BaseLayout
  title="Midway Wrestling Club | Home"
  description="Youth wrestling club focused on technique, confidence, and competition readiness."
>
  <Hero
    title="Midway Wrestling Club"
    subtitle="Midway wrestlers in action."
    primaryLabel="Call/Text Coach"
    primaryHref="tel:+19704242757"
    secondaryLabel="Join Updates"
    secondaryHref="/join"
    showCtas={false}
  >
    <div slot="below-title" class="hero-photos">
      <p class="eyebrow">Moments from the mat</p>
      <div class="photo-scroll" aria-label="Photo highlights" data-photo-scroll>
        {displayPhotos.map((photo) => {
          const altText = photo.alt ?? "Midway Wrestling Club photo";
          return (
            <figure class="photo-tile">
              {photo.src ? (
                <button
                  class="photo-lightbox-trigger"
                  type="button"
                  data-lightbox-src={photo.src}
                  data-lightbox-alt={altText}
                  aria-label={`View ${altText}`}
                >
                  <img
                    class="photo-tile__img"
                    src={photo.src}
                    alt={altText}
                    loading="lazy"
                    decoding="async"
                  />
                </button>
              ) : (
                <span class="photo-placeholder">{photo.label}</span>
              )}
            </figure>
          );
        })}
      </div>
    </div>
    <div slot="aside">
      <Card
        accent
        meta="Beginner Interest"
        title="2026/2027 Beginner Group Interest Form"
        description="Please fill out this form if you are interested in an additional, more beginner-focused practice session for the 2026/2027 season."
      >
        <img
          slot="media"
          class="hero-logo"
          src="/logos/combo_no_bg.png"
          alt="Midway Wrestling Club logo"
          width="220"
          height="220"
          loading="lazy"
          decoding="async"
        />
        <div class="hero-card-cta-wrap">
          <a class="btn primary hero-card-cta" href="/beginner-interest">Open Interest Form</a>
        </div>
      </Card>
    </div>
  </Hero>

  <Section
    id="glance"
    eyebrow="At a glance"
    title="Current club information"
    intro="Key details for parents and athletes."
  >
    <div class="grid grid-2 grid-4">
      <Card
        meta="Age Groups"
        title="Ages 10-High School"
        description="3-4 years of wrestling experience is highly recommended."
      />
      <Card
        meta="Schedule"
        title="Monday & Wednesday"
        description="6:30-7:45 PM."
      />
      <Card
        meta="Location"
        title="Delta Middle School"
        description="401 E 10th St, Delta, CO 81416."
      />
      <Card
        meta="Cost"
        title="$80/month"
        description="Sibling/Family discounts available"
      />
    </div>
  </Section>

  <script is:inline>
    const scrollers = document.querySelectorAll("[data-photo-scroll]");
    const prefersReducedMotion = window.matchMedia(
      "(prefers-reduced-motion: reduce)"
    ).matches;

    scrollers.forEach((scroller) => {
      if (prefersReducedMotion) return;
      const items = scroller.children;
      if (items.length < 2) return;

      let intervalId = null;
      let isPaused = false;

      const getStep = () => {
        if (items.length < 2) return 0;
        const first = items[0];
        const second = items[1];
        const offsetStep = second.offsetLeft - first.offsetLeft;
        return offsetStep || first.getBoundingClientRect().width;
      };

      const scrollNext = () => {
        if (isPaused) return;
        const step = getStep();
        if (!step) return;
        const maxScrollLeft = scroller.scrollWidth - scroller.clientWidth;
        const next = scroller.scrollLeft + step;
        if (next >= maxScrollLeft - 2) {
          scroller.scrollTo({ left: 0, behavior: "smooth" });
        } else {
          scroller.scrollTo({ left: next, behavior: "smooth" });
        }
      };

      const start = () => {
        if (intervalId) return;
        intervalId = window.setInterval(scrollNext, 3500);
      };

      const stop = () => {
        if (!intervalId) return;
        window.clearInterval(intervalId);
        intervalId = null;
      };

      const pause = () => {
        isPaused = true;
        stop();
      };

      const resume = () => {
        isPaused = false;
        start();
      };

      scroller.addEventListener("pointerenter", pause);
      scroller.addEventListener("pointerleave", resume);
      scroller.addEventListener("focusin", pause);
      scroller.addEventListener("focusout", resume);
      scroller.addEventListener("touchstart", pause, { passive: true });
      scroller.addEventListener("touchend", resume);
      window.addEventListener("resize", () => {
        if (!isPaused) {
          stop();
          start();
        }
      });

      const startAuto = () => {
        if (!isPaused) start();
      };

      if (document.readyState === "loading") {
        window.addEventListener("load", startAuto, { once: true });
      } else {
        startAuto();
      }
    });
  </script>

  <Section
    id="news"
    eyebrow="News"
    title="Latest club news."
    intro="Updates, events, and reminders from the coaching staff."
  >
    <div class="grid grid-2 grid-3">
      {latestNews.map((entry) => {
        const isLogoCover = entry.data.coverStyle === "logo";
        return (
          <Card
            meta={formatDate(entry.data.date)}
            title={entry.data.title}
          >
            {entry.data.cover &&
              (isLogoCover ? (
                <div slot="media" class="card-media__frame card-media__frame--logo">
                  <img
                    class="card-media__logo"
                    src={entry.data.cover}
                    alt=""
                    loading="lazy"
                    decoding="async"
                  />
                </div>
              ) : (
                <div slot="media" class="card-media__frame">
                  <img
                    class="card-media__img"
                    src={entry.data.cover}
                    alt=""
                    loading="lazy"
                    decoding="async"
                  />
                </div>
              ))}
            <a class="btn outline" href={`/news/${entry.slug}`}>Read Article</a>
          </Card>
        );
      })}
    </div>
    <div class="cta-row">
      <a class="btn outline" href="/news">View All News</a>
    </div>
  </Section>

  <div class="lightbox" data-lightbox hidden>
    <button class="lightbox__overlay" type="button" data-lightbox-close aria-hidden="true"></button>
    <div class="lightbox__panel" role="dialog" aria-modal="true" aria-label="Photo viewer">
      <img class="lightbox__img" data-lightbox-img alt="" />
      <button class="btn secondary lightbox__close" type="button" data-lightbox-close>
        Close
      </button>
    </div>
  </div>

  <script is:inline>
    const lightbox = document.querySelector("[data-lightbox]");
    const lightboxImg = lightbox?.querySelector("[data-lightbox-img]");
    const lightboxTriggers = document.querySelectorAll("[data-lightbox-src]");
    let lastFocused = null;

    const openLightbox = (src, alt) => {
      if (!lightbox || !lightboxImg || !src) return;
      lastFocused = document.activeElement;
      lightboxImg.src = src;
      lightboxImg.alt = alt || "Midway Wrestling Club photo";
      lightbox.hidden = false;
      document.body.classList.add("modal-open");
      const closeButton = lightbox.querySelector("[data-lightbox-close]");
      if (closeButton) closeButton.focus();
    };

    const closeLightbox = () => {
      if (!lightbox || !lightboxImg) return;
      lightbox.hidden = true;
      document.body.classList.remove("modal-open");
      lightboxImg.src = "";
      lightboxImg.alt = "";
      if (lastFocused && lastFocused.focus) {
        lastFocused.focus();
      }
    };

    if (lightbox) {
      lightbox.addEventListener("click", (event) => {
        if (event.target.closest("[data-lightbox-close]")) {
          closeLightbox();
        }
      });
    }

    lightboxTriggers.forEach((trigger) => {
      trigger.addEventListener("click", () => {
        const src = trigger.getAttribute("data-lightbox-src");
        const alt = trigger.getAttribute("data-lightbox-alt") || "";
        openLightbox(src, alt);
      });
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && lightbox && !lightbox.hidden) {
        closeLightbox();
      }
    });
  </script>
</BaseLayout>
