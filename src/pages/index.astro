---
import BaseLayout from "../layouts/BaseLayout.astro";
import Hero from "../components/Hero.astro";
import Section from "../components/Section.astro";
import Card from "../components/Card.astro";
import { getCollection } from "astro:content";
import { readdir } from "node:fs/promises";

const news = await getCollection("news");
const latestNews = news
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 3);
const formatDate = (date) =>
  date.toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
  });

const photosDir = new URL("../../public/photos", import.meta.url);
const photoFiles = await readdir(photosDir);
const photoItems = photoFiles
  .filter((file) => /\.(png|jpe?g|webp|gif|avif)$/i.test(file))
  .map((file) => {
    const label = file.replace(/\.[^.]+$/, "").replace(/[-_]+/g, " ").trim();
    return {
      src: `/photos/${file}`,
      alt: label ? `${label} photo` : "Midway Wrestling Club photo",
    };
  });
const placeholderPhotos = [
  { label: "Live goes" },
  { label: "Technique reps" },
  { label: "Team focus" },
  { label: "Tournament day" },
];
const displayPhotos = photoItems.length ? photoItems : placeholderPhotos;
---

<BaseLayout
  title="Midway Wrestling Club | Home"
  description="Youth wrestling club focused on technique, confidence, and competition readiness."
>
  <Hero
    title="Midway Wrestling Club"
    subtitle="Build grit, strength, and confidence through focused coaching and an accountable team culture."
    primaryLabel="Call/Text Coach"
    primaryHref="tel:+19704242757"
    secondaryLabel="Join Updates"
    secondaryHref="/join"
    showCtas={false}
  >
    <div slot="below-title" class="hero-photos">
      <p class="eyebrow">Moments from the mat</p>
      <div class="photo-scroll" aria-label="Photo highlights" data-photo-scroll>
        {displayPhotos.map((photo) => (
          <figure class="photo-tile">
            {photo.src ? (
              <img
                class="photo-tile__img"
                src={photo.src}
                alt={photo.alt ?? ""}
                loading="lazy"
                decoding="async"
              />
            ) : (
              <span class="photo-placeholder">{photo.label}</span>
            )}
          </figure>
        ))}
      </div>
    </div>
    <div slot="aside">
      <Card
        accent
        meta="Season Snapshot"
        title="2026 Fall/Winter"
        description="Start date: October 13th"
      >
        <img
          slot="media"
          class="hero-logo"
          src="/logos/combo_no_bg.png"
          alt="Midway Wrestling Club logo"
          width="220"
          height="220"
          loading="lazy"
          decoding="async"
        />
      </Card>
    </div>
  </Hero>

  <Section
    id="glance"
    eyebrow="At a glance"
    title="Current club information"
    intro="Key details for parents and athletes."
  >
    <div class="grid grid-2 grid-4">
      <Card
        meta="Age Groups"
        title="Ages 10-High School"
        description="2-3 years of wrestling experience is highly recommended."
      />
      <Card
        meta="Schedule"
        title="Monday & Wednesday"
        description="6:30-7:45 PM."
      />
      <Card
        meta="Location"
        title="Delta Middle School"
        description="401 E 10th St, Delta, CO 81416."
      />
      <Card
        meta="Cost"
        title="$80/month"
        description="Sibling/Family discounts available"
      />
    </div>
  </Section>

  <script is:inline>
    const scrollers = document.querySelectorAll("[data-photo-scroll]");
    const prefersReducedMotion = window.matchMedia(
      "(prefers-reduced-motion: reduce)"
    ).matches;

    scrollers.forEach((scroller) => {
      if (prefersReducedMotion) return;
      const items = scroller.children;
      if (items.length < 2) return;

      let intervalId = null;
      let isPaused = false;

      const getStep = () => {
        if (items.length < 2) return 0;
        const first = items[0];
        const second = items[1];
        const offsetStep = second.offsetLeft - first.offsetLeft;
        return offsetStep || first.getBoundingClientRect().width;
      };

      const scrollNext = () => {
        if (isPaused) return;
        const step = getStep();
        if (!step) return;
        const maxScrollLeft = scroller.scrollWidth - scroller.clientWidth;
        const next = scroller.scrollLeft + step;
        if (next >= maxScrollLeft - 2) {
          scroller.scrollTo({ left: 0, behavior: "smooth" });
        } else {
          scroller.scrollTo({ left: next, behavior: "smooth" });
        }
      };

      const start = () => {
        if (intervalId) return;
        intervalId = window.setInterval(scrollNext, 3500);
      };

      const stop = () => {
        if (!intervalId) return;
        window.clearInterval(intervalId);
        intervalId = null;
      };

      const pause = () => {
        isPaused = true;
        stop();
      };

      const resume = () => {
        isPaused = false;
        start();
      };

      scroller.addEventListener("pointerenter", pause);
      scroller.addEventListener("pointerleave", resume);
      scroller.addEventListener("focusin", pause);
      scroller.addEventListener("focusout", resume);
      scroller.addEventListener("touchstart", pause, { passive: true });
      scroller.addEventListener("touchend", resume);
      window.addEventListener("resize", () => {
        if (!isPaused) {
          stop();
          start();
        }
      });

      const startAuto = () => {
        if (!isPaused) start();
      };

      if (document.readyState === "loading") {
        window.addEventListener("load", startAuto, { once: true });
      } else {
        startAuto();
      }
    });
  </script>

  <Section
    id="news"
    eyebrow="News"
    title="Latest club news."
    intro="Updates, events, and reminders from the coaching staff."
  >
    <div class="grid grid-2 grid-3">
      {latestNews.map((entry) => (
        <Card
          meta={formatDate(entry.data.date)}
          title={entry.data.title}
          description={entry.data.excerpt}
        >
          <a class="btn outline" href={`/news/${entry.slug}`}>Read Article</a>
        </Card>
      ))}
    </div>
    <div class="cta-row">
      <a class="btn outline" href="/news">View All News</a>
    </div>
  </Section>

</BaseLayout>
