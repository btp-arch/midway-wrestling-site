---
import BaseLayout from "../layouts/BaseLayout.astro";
import Section from "../components/Section.astro";
import Card from "../components/Card.astro";
import CTAButtons from "../components/CTAButtons.astro";
---

<BaseLayout
  title="Join | Midway Wrestling Club"
  description="Join Midway Wrestling Club or contact the coaches with a quick message."
>
  <Section
    eyebrow="Join"
    title="Join Midway Wrestling Club"
    intro="Send a quick note and we will follow up with the best practice option."
  >
    <div class="grid grid-2">
      <div class="stack" data-form-wrapper>
        <form
          class="form-card"
          name="join-form"
          method="post"
          action="https://formspree.io/f/mldznlgw"
          data-formspree
          data-success-message="Thanks for submitting a request to join Midway Wrestling Club. A coach will reach out shortly with additional information."
        >
          <div class="grid grid-2">
            <div class="field">
              <label for="join-name">Parent/Guardian Name</label>
              <input
                id="join-name"
                name="name"
                type="text"
                autocomplete="name"
                placeholder="Full name"
                required
              />
            </div>
            <div class="field">
              <label for="join-email">Email</label>
              <input
                id="join-email"
                name="email"
                type="email"
                autocomplete="email"
                placeholder="you@email.com"
                required
              />
            </div>
          </div>
          <div class="grid grid-2">
            <div class="field">
              <label for="join-phone">Phone</label>
              <input
                id="join-phone"
                name="phone"
                type="tel"
                autocomplete="tel"
                placeholder="(555) 123-4567"
                required
              />
            </div>
            <div class="field">
              <label for="join-age">Athlete Age</label>
              <input
                id="join-age"
                name="athlete-age"
                type="text"
                placeholder="e.g., 10"
                required
              />
            </div>
          </div>
          <div class="field">
            <label for="join-message">Message</label>
            <textarea
              id="join-message"
              name="message"
              placeholder="Tell us about your wrestlers experience, weight class/range, and when they can start. Also any questions you may have."
              required
            ></textarea>
          </div>
          <button class="btn primary" type="submit">Send Message</button>
        </form>
        <div class="form-card form-error" data-form-error role="alert" hidden>
          Something went wrong. Please try again or text the coach directly.
        </div>
      </div>

      <div class="stack">
        <div class="stack" data-form-wrapper>
          <form
            class="form-card"
            name="updates-form"
            method="post"
            action="https://formspree.io/f/meeeoova"
            data-formspree
            data-success-message="You are signed up to receive email updates about the club and practice cancellations/updates."
          >
            <h3>Join Updates</h3>
            <p class="muted">Get schedule changes and event reminders.</p>
            <div class="form-row">
              <div class="field">
                <label for="updates-email">Email</label>
                <input
                  id="updates-email"
                  name="email"
                  type="email"
                  placeholder="you@email.com"
                  required
                />
              </div>
              <button class="btn secondary" type="submit">Join Updates</button>
            </div>
            <p class="note">We will only send wrestling club updates.</p>
          </form>
          <div class="form-card form-error" data-form-error role="alert" hidden>
            Something went wrong. Please try again.
          </div>
        </div>

        <Card title="Prefer to talk first?" description="Call or text the head coach for a quick answer.">
          <CTAButtons
            primaryLabel="Call/Text Coach"
            primaryHref="tel:+19704242757"
            secondaryLabel="View Schedule"
            secondaryHref="/schedule"
            secondaryVariant="outline"
          />
        </Card>
      </div>
    </div>
  </Section>

  <div class="modal" data-modal hidden>
    <button class="modal__overlay" type="button" data-modal-close aria-hidden="true"></button>
    <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <p class="modal__title" id="modal-title">Message sent</p>
      <p class="modal__message" data-modal-message></p>
      <button class="btn secondary" type="button" data-modal-close>Close</button>
    </div>
  </div>

  <script is:inline>
    const wrappers = document.querySelectorAll("[data-form-wrapper]");
    const modal = document.querySelector("[data-modal]");
    const modalMessage = modal?.querySelector("[data-modal-message]");

    const openModal = (message) => {
      if (!modal || !modalMessage) return;
      modalMessage.textContent = message;
      modal.hidden = false;
      document.body.classList.add("modal-open");
      const closeButton = modal.querySelector("[data-modal-close]");
      if (closeButton) closeButton.focus();
    };

    const closeModal = () => {
      if (!modal) return;
      modal.hidden = true;
      document.body.classList.remove("modal-open");
    };

    if (modal) {
      modal.addEventListener("click", (event) => {
        if (event.target.closest("[data-modal-close]")) {
          closeModal();
        }
      });
    }

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && modal && !modal.hidden) {
        closeModal();
      }
    });

    wrappers.forEach((wrapper) => {
      const form = wrapper.querySelector("form[data-formspree]");
      const error = wrapper.querySelector("[data-form-error]");
      if (!form) return;

      const showError = () => {
        if (!error) return;
        error.hidden = false;
        window.setTimeout(() => {
          error.hidden = true;
        }, 4000);
      };

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const submitButton = form.querySelector('button[type="submit"]');
        const originalLabel = submitButton?.textContent;
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = "Sending...";
        }

        try {
          const response = await fetch(form.action, {
            method: "POST",
            body: new FormData(form),
            headers: { Accept: "application/json" },
          });
          if (response.ok) {
            form.reset();
            if (error) error.hidden = true;
            openModal(form.dataset.successMessage || "Thanks for your message.");
          } else {
            showError();
          }
        } catch (err) {
          showError();
        } finally {
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = originalLabel || "Submit";
          }
        }
      });
    });
  </script>
</BaseLayout>
